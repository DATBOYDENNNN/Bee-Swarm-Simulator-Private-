local Library = loadstring(game:HttpGet('https://raw.githubusercontent.com/Rain-Design/Unnamed/main/Library.lua'))()
Library.Theme = "Dark"

-- ========== CONFIGURATION / STATE ==========
local Config = {
    isFarming = false,
    currentField = "Sunflower Field",
    walkSpeed = 50,
    collectRadius = 120, 
    isConverting = false,
    myPlatform = nil,
    farmBubbles = false,
    farmBalloons = false,
    autoClicker = true,
    movementPattern = "Spiral", 
    beeColor = Color3.fromRGB(255, 255, 255),
    rainbowBees = false
}

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local VirtualUser = game:GetService("VirtualUser")
local player = Players.LocalPlayer

local FlowerZones = workspace:WaitForChild("FlowerZones")
local Fields = {"Sunflower Field", "Mushroom Field", "Clover Field", "Spider Field", "Blue Flower Field", "Strawberry Field", "Bamboo Field", "Pine Tree Forest", "Cactus Field", "Pumpkin Patch", "Rose Field", "Mountain Top Field", "Ant Field"}

-- ========== ANTI-AFK ==========
player.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- ========== PERMANENT SPEED LOCK ==========
RunService.Stepped:Connect(function()
    if player.Character and player.Character:FindFirstChild("Humanoid") then
        player.Character.Humanoid.WalkSpeed = Config.walkSpeed
    end
end)

-- ========== CORE FUNCTIONS ==========
local function scanForHive()
    local platforms = workspace:FindFirstChild("HivePlatforms")
    if platforms then
        for _, plat in pairs(platforms:GetChildren()) do
            local playerRef = plat:FindFirstChild("PlayerRef")
            if playerRef and playerRef.Value == player then 
                Config.myPlatform = plat
                return true 
            end
        end
    end
    return false
end

local function deployToField()
    local zone = FlowerZones:FindFirstChild(Config.currentField)
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if zone and hrp then
        hrp.Anchored = false 
        hrp.Velocity = Vector3.zero
        hrp.CFrame = zone.CFrame * CFrame.new(0, 3, 0)
        task.wait(0.2)
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.One, false, game)
        task.wait(0.05)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.One, false, game)
    end
end

-- ========== UI SETUP ==========
local Window = Library:Window({ Text = "BSS Internal V76 - DELUXE" })

local MainTab = Window:Tab({ Text = "Macro Setup" })
local TPTab = Window:Tab({ Text = "Teleports" })
local QuestTab = Window:Tab({ Text = "Quests" })
local ExploitTab = Window:Tab({ Text = "Exploits" })
local VisualsTab = Window:Tab({ Text = "Visuals" })
local SettingsTab = Window:Tab({ Text = "Settings" })

local FarmSection = MainTab:Section({ Text = "Automation" })
local MoveSection = MainTab:Section({ Text = "Movement Style" })
local TPSection = TPTab:Section({ Text = "Field Teleports" })
local QuestSection = QuestTab:Section({ Text = "NPC Teleports" })
local BeeSection = ExploitTab:Section({ Text = "Bee Customization" })
local ThemeSection = VisualsTab:Section({ Text = "UI Themes" })
local ConfigSection = SettingsTab:Section({ Text = "Configuration" })

-- !!! FIX: DROPDOWN TEXT UPDATER !!!
local FieldDropdown = FarmSection:Dropdown({
    Text = "Current Field: " .. Config.currentField,
    List = Fields,
    Callback = function(v)
        Config.currentField = v
        -- If your library supports renaming the label:
        -- FieldDropdown:SetText("Field: " .. v) 
        print("Selected Field: " .. v)
    end
})

-- Movement Style Dropdown
MoveSection:Dropdown({
    Text = "Pattern Type",
    List = {"Direct", "Spiral", "ZigZag"},
    Callback = function(v) Config.movementPattern = v end
})

-- Bee Customization
BeeSection:Toggle({ Text = "Rainbow Bees", Callback = function(v) Config.rainbowBees = v end })

-- Theme Customization
ThemeSection:Button({ Text = "Dark Mode", Callback = function() Library.Theme = "Dark" end })
ThemeSection:Button({ Text = "Light Mode", Callback = function() Library.Theme = "Light" end })

-- Main Config Sliders
ConfigSection:Slider({ Text = "WalkSpeed", Default = 50, Minimum = 16, Maximum = 200, Callback = function(v) Config.walkSpeed = v end })
ConfigSection:Slider({ Text = "Collect Radius", Default = 120, Minimum = 20, Maximum = 300, Callback = function(v) Config.collectRadius = v end })

local farmToggle = FarmSection:Toggle({
    Text = "ENABLE MACRO (Q)",
    Callback = function(bool)
        Config.isFarming = bool
        if Config.isFarming then scanForHive() deployToField() end
    end
})

-- Teleport Buttons
for _, name in ipairs(Fields) do 
    TPSection:Button({Text = name, Callback = function() player.Character.HumanoidRootPart.CFrame = FlowerZones[name].CFrame * CFrame.new(0,5,0) end}) 
end

-- NPC Buttons
for _, b in ipairs({"Black Bear", "Brown Bear", "Panda Bear", "Science Bear", "Polar Bear", "Mother Bear"}) do
    QuestSection:Button({Text = b, Callback = function() 
        local n = workspace.NPCs:FindFirstChild(b) 
        if n then player.Character.HumanoidRootPart.CFrame = n:GetPivot() * CFrame.new(0,3,0) end 
    end})
end

-- ========== STUTTER-STEP MOVEMENT ENGINE ==========
local ignoredTokens = {}
local moveAngle = 0

RunService.Heartbeat:Connect(function()
    if not Config.isFarming or Config.isConverting then return end
    
    local char = player.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    local hum = char and char:FindFirstChild("Humanoid")
    if not hrp or not hum then return end

    -- Jump if stuck (Bamboo stalks)
    if hrp.Velocity.Magnitude < 2 and hum.MoveDirection.Magnitude > 0 then hum.Jump = true end

    local zone = FlowerZones:FindFirstChild(Config.currentField)
    local bestTarget = nil
    local minDistance = Config.collectRadius
    
    local targets = {}
    local folders = {workspace:FindFirstChild("Collectibles"), workspace:FindFirstChild("Tokens")}
    for _, f in pairs(folders) do if f then for _, v in pairs(f:GetChildren()) do table.insert(targets, v) end end end

    for _, token in pairs(targets) do
        if not ignoredTokens[token] then
            local pos = token:IsA("BasePart") and token.Position or token:GetPivot().Position
            local dist = (hrp.Position - pos).Magnitude
            if dist < minDistance then
                minDistance = dist
                bestTarget = token
            end
        end
    end

    if bestTarget then
        local targetPos = bestTarget:IsA("BasePart") and bestTarget.Position or bestTarget:GetPivot().Position
        local finalDestination = targetPos

        if Config.movementPattern == "Spiral" then
            moveAngle = moveAngle + 0.2
            local offset = Vector3.new(math.cos(moveAngle) * 6, 0, math.sin(moveAngle) * 6)
            finalDestination = targetPos + offset
        elseif Config.movementPattern == "ZigZag" then
            moveAngle = moveAngle + 0.1
            local offset = Vector3.new(math.sin(moveAngle) * 10, 0, 0)
            finalDestination = targetPos + offset
        end

        hum:MoveTo(finalDestination)
        
        if (hrp.Position - targetPos).Magnitude < 4 then
            ignoredTokens[bestTarget] = true
            task.delay(0.4, function() ignoredTokens[bestTarget] = nil end)
        end
    elseif zone then
        hum:MoveTo(zone.Position)
    end
end)

-- ========== AUTO-CONVERT (AGGRESSIVE 5S) ==========
task.spawn(function()
    while task.wait(1) do
        local stats = player:FindFirstChild("CoreStats")
        local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        
        if Config.isFarming and stats and stats.Pollen.Value >= stats.Capacity.Value and not Config.isConverting then
            Config.isConverting = true
            if not Config.myPlatform then scanForHive() end
            
            hrp.Velocity = Vector3.zero
            local platPos = Config.myPlatform:GetPivot()
            hrp.CFrame = CFrame.new(platPos.X, platPos.Y + 3, platPos.Z) 
            task.wait(0.5)
            hrp.Anchored = true 
            
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
            
            local lastPollen = stats.Pollen.Value
            local stuckTicks = 0

            while Config.isFarming and stats.Pollen.Value > 0 do
                task.wait(1)
                if stats.Pollen.Value >= lastPollen then stuckTicks = stuckTicks + 1 else stuckTicks = 0 end
                if stuckTicks >= 5 then
                    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
                    stuckTicks = 0
                end
                lastPollen = stats.Pollen.Value
            end
            
            task.wait(2) 
            hrp.Anchored = false
            Config.isConverting = false
            deployToField()
        end
    end
end)

-- ========== INPUTS ==========
UserInputService.InputBegan:Connect(function(i, gpe)
    if gpe then return end
    if i.KeyCode == Enum.KeyCode.Q then 
        Config.isFarming = not Config.isFarming 
        farmToggle:Set(Config.isFarming)
    elseif i.KeyCode == Enum.KeyCode.F3 then
        local ui = game:GetService("CoreGui"):FindFirstChild("Unnamed") or player.PlayerGui:FindFirstChild("Unnamed")
        if ui then ui.Enabled = not ui.Enabled end
    end
end)
